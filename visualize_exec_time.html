 <!DOCTYPE html>
 <html>
  <head>
    <meta charset="UTF-8"/>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});

      var waitingOnRequestsToFinish = 0;
      // We want to draw the table after all of the ajax requests have resolved
      // This function is used to trigger the function after the ajax requests have all finished.
      function drawTrigger(delta) {
        // Yes, global state is bad...
        waitingOnRequestsToFinish += delta;
        if (waitingOnRequestsToFinish === 0)
        {
          drawChart();
        }
      }

      function handleAjaxError(request) {
        // But shouldn't 200 not be an error? Well sort of. Because we are requesting files I wrote, it thinks there's an error because the server sees it as text but the browser was expecting jsonp. This is the workaround!
        // It also means that there will be no success calls made if you set your ajax request to that.
        if (request.status != 200) {
            console.log("ERR:");
            console.log(request.status);
        }
        drawTrigger(-1);
      }

      function isValid(data) {
        return typeof data["build_number"] === 'number' &&
               data["build_times"].length === 4;
      }

      var dataForChart = [];
      function jenkinsCallback(data) {
        // ignore bad data
        if (!isValid(data))
        {
          return;
        }
        rowData = [String(data["build_number"])].concat(data["build_times"]);
        dataForChart = dataForChart.concat([rowData]);
      }

      // Calls Jenkins to get the data dumped from build
      function getJenkinsData(build_number) {
        drawTrigger(1);
        $.ajax({
          'global': false,
          // TODO: branch should be master for final submission
          // TODO: we should specify the file that's loaded dynamically for easily making new tests
          'url': `http://vm-dcaf-bld-14:8080/job/Integration/${build_number}/artifact/build_temp/exec_time.json`,
          'dataType': "jsonp",
          'error': function (request) { handleAjaxError(request); },

        });
      }

      function requestJenkinsData(data) {
        for (i = data.number; i > 0; i--) {
          getJenkinsData(i);
        }
      }

      function getLastBuild() {
        drawTrigger(1);
        console.log('a');
        $.ajax({
          'global': false,
          'url': 'http://vm-dcaf-bld-14:8080/job/Integration/lastSuccessfulBuild/api/json?jsonp=requestJenkinsData',
          'dataType': "jsonp",
          'error': function (request) { handleAjaxError(request); },
        });
      }

      function drawChart() {
        console.log(`Number of waitingOnRequestsToFinish: ${waitingOnRequestsToFinish}`);
        // TODO: drive the labels from the json to make this code agnostic to the test
        var header = ['Build', 'Max', '99.9 Percentile', '99 Percentile', '95 Percentile']
        var rawData = [header];
        var sortedData = dataForChart.sort(function(a, b) {
          return a[0] - b[0];
        });
       
        sortedData.forEach(function(item) { rawData = rawData.concat([item]); });

        console.log("Raw Chart Data:");
        console.log(rawData);
        var data = google.visualization.arrayToDataTable(rawData);

        var options = {
          title: 'PC Loop Iteration Time',
          legend: { position: 'bottom' },
          focusTarget: 'category',
          hAxis: { title: 'Jenkin Build Number' },
          vAxis: { title: 'Loop Iteration Time (seconds)'},
        };

        var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

        // Set the number of digits on our data.
        var formatter = new google.visualization.NumberFormat(
          { fractionDigits: 5 }
          );
        formatter.format(data, 1);
        formatter.format(data, 2);
        formatter.format(data, 3);
        formatter.format(data, 4);
        chart.draw(data, options);

        var hideMax = document.getElementById("hideMax");
        var maxIsHidden = false;
        hideMax.onclick = function()
        {
          view = new google.visualization.DataView(data);
          if (maxIsHidden) {
            view.setColumns([0,1,2,3,4]);
          }
          else {
            view.hideColumns([1]);
          }
          maxIsHidden = !maxIsHidden;
          
          chart.draw(view, options);
        }

      }


      getLastBuild();
    </script>
  </head>
  <body onresize="drawChart()">
    <div id="curve_chart" style="width: *; height: 500px;"></div>
    <button type="button" id="hideMax">Hide Max</button>
  </body>
</html>

